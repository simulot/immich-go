name: E2E Tests

on:
    pull_request:
        branches:
            - main
            - develop
        paths:
            - "**.go"
            - "go.mod"
            - "go.sum"
            - ".github/workflows/ci-e2e.yml"
            - "main.go"
            - "internal/e2e/testdata/immich-server/**"
    push:
        branches:
            - main
            - develop
        paths:
            - "**.go"
            - "go.mod"
            - "go.sum"
            - ".github/workflows/ci-e2e.yml"
            - "main.go"
            - "internal/e2e/testdata/immich-server/**"
    workflow_dispatch:
        inputs:
            skip_approval:
                description: "Skip approval check (maintainers only)"
                required: false
                type: boolean
                default: false

permissions:
    contents: read
    pull-requests: read

env:
    project_dir: /home/runner/work/immich-go/immich-go
    e2e_folder: /home/runner/work/immich-go/immich-go/internal/e2e/testdata/immich-server
    e2e_users: /home/runner/work/immich-go/immich-go/internal/e2e/testdata/immich-server/e2eusers.env
    e2e_server: e2e-immich-${{ github.run_id }}
    e2e_url: http://e2e-immich-${{ github.run_id }}:2283
    e2e_ssh: root@e2e-immich-${{ github.run_id }}
    runner_timeout: 900

jobs:
    check-approval:
        name: Check if E2E tests should run
        runs-on: ubuntu-latest
        outputs:
            should-run: ${{ steps.decision.outputs.should-run }}
            is-external: ${{ steps.check-contributor.outputs.is-external }}
        steps:
            - name: Checkout Code
              uses: actions/checkout@v5
              with:
                  fetch-depth: 2

            - name: Check contributor status
              id: check-contributor
              env:
                  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                  ACTOR="${{ github.actor }}"
                  REPO="${{ github.repository }}"

                  echo "Checking contributor status for: $ACTOR"

                  # Check if this is a push to main/develop (always trusted)
                  if [[ "${{ github.event_name }}" == "push" ]]; then
                    echo "Push event to protected branch - auto-approved"
                    echo "is-external=false" >> $GITHUB_OUTPUT
                    exit 0
                  fi

                  # Check if manual workflow dispatch with skip_approval flag
                  if [[ "${{ github.event_name }}" == "workflow_dispatch" ]] && [[ "${{ inputs.skip_approval }}" == "true" ]]; then
                    echo "Manual workflow dispatch with skip_approval - auto-approved"
                    echo "is-external=false" >> $GITHUB_OUTPUT
                    exit 0
                  fi

                  # Check if contributor is a repository collaborator
                  if gh api "/repos/$REPO/collaborators/$ACTOR" --silent 2>/dev/null; then
                    echo "‚úÖ $ACTOR is a repository collaborator - auto-approved"
                    echo "is-external=false" >> $GITHUB_OUTPUT
                  else
                    echo "‚ö†Ô∏è  $ACTOR is an external contributor - requires approval"
                    echo "is-external=true" >> $GITHUB_OUTPUT
                  fi

            - name: Check for approval label
              id: check-label
              if: steps.check-contributor.outputs.is-external == 'true'
              env:
                  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                  if [[ "${{ github.event_name }}" != "pull_request" ]]; then
                    echo "Not a PR event, skipping label check"
                    echo "has-label=false" >> $GITHUB_OUTPUT
                    exit 0
                  fi

                  PR_NUMBER="${{ github.event.pull_request.number }}"
                  REPO="${{ github.repository }}"

                  echo "Checking for 'e2e-approved' label on PR #$PR_NUMBER"

                  if gh pr view "$PR_NUMBER" --repo "$REPO" --json labels --jq '.labels[].name' | grep -q "^e2e-approved$"; then
                    echo "‚úÖ PR has 'e2e-approved' label"
                    echo "has-label=true" >> $GITHUB_OUTPUT
                  else
                    echo "‚ùå PR does not have 'e2e-approved' label"
                    echo "has-label=false" >> $GITHUB_OUTPUT
                  fi

            - name: Check if E2E-relevant changes exist
              id: check-changes
              run: |
                  if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
                    echo "Manual trigger - will run E2E tests"
                    echo "has-changes=true" >> $GITHUB_OUTPUT
                    exit 0
                  fi

                  CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD 2>/dev/null || echo "")

                  if [[ -z "$CHANGED_FILES" ]]; then
                    echo "Could not determine changed files - skipping E2E tests"
                    echo "has-changes=false" >> $GITHUB_OUTPUT
                    exit 0
                  fi

                  echo "Changed files:"
                  echo "$CHANGED_FILES"

                  # Check if only documentation files were changed
                  NON_DOC_FILES=$(echo "$CHANGED_FILES" | grep -vE '\.md$|^docs/|^README|^CONTRIBUTING|^LICENSE')

                  if [[ -z "$NON_DOC_FILES" ]]; then
                    echo "‚è≠Ô∏è Only documentation files changed - skipping E2E tests"
                    echo "has-changes=false" >> $GITHUB_OUTPUT
                    exit 0
                  fi

                  if echo "$CHANGED_FILES" | grep -qE '^(app|adapters|immich|internal)/|^main\.go$|^go\.(mod|sum)$|^internal/e2e/testdata/immich-server/'; then
                    echo "‚úÖ E2E-relevant changes detected"
                    echo "has-changes=true" >> $GITHUB_OUTPUT
                  else
                    echo "‚è≠Ô∏è No E2E-relevant changes"
                    echo "has-changes=false" >> $GITHUB_OUTPUT
                  fi

            - name: Make decision
              id: decision
              run: |
                  IS_EXTERNAL="${{ steps.check-contributor.outputs.is-external }}"
                  HAS_LABEL="${{ steps.check-label.outputs.has-label }}"
                  HAS_CHANGES="${{ steps.check-changes.outputs.has-changes }}"

                  echo "Decision factors:"
                  echo "  - Is external contributor: $IS_EXTERNAL"
                  echo "  - Has approval label: $HAS_LABEL"
                  echo "  - Has E2E-relevant changes: $HAS_CHANGES"

                  # Skip if no relevant changes
                  if [[ "$HAS_CHANGES" != "true" ]]; then
                    echo "‚è≠Ô∏è No E2E-relevant changes - skipping tests"
                    echo "should-run=false" >> $GITHUB_OUTPUT
                    exit 0
                  fi

                  # Auto-approve for trusted contributors
                  if [[ "$IS_EXTERNAL" != "true" ]]; then
                    echo "‚úÖ Trusted contributor - running E2E tests"
                    echo "should-run=true" >> $GITHUB_OUTPUT
                    exit 0
                  fi

                  # External contributors require label
                  if [[ "$HAS_LABEL" == "true" ]]; then
                    echo "‚úÖ External PR approved via label - running E2E tests"
                    echo "should-run=true" >> $GITHUB_OUTPUT
                  else
                    echo "‚è∏Ô∏è  External PR requires 'e2e-approved' label - skipping tests"
                    echo ""
                    echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
                    echo "  ‚ö†Ô∏è  E2E Tests Require Approval"
                    echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
                    echo ""
                    echo "This PR is from an external contributor and requires"
                    echo "manual approval before E2E tests can run."
                    echo ""
                    echo "Maintainers: Review the changes and add the"
                    echo "'e2e-approved' label to trigger E2E tests."
                    echo ""
                    echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
                    echo "should-run=false" >> $GITHUB_OUTPUT
                  fi

            - name: Comment on PR if approval needed
              if: |
                  github.event_name == 'pull_request' &&
                  steps.check-contributor.outputs.is-external == 'true' &&
                  steps.check-label.outputs.has-label != 'true' &&
                  steps.check-changes.outputs.has-changes == 'true'
              env:
                  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                  PR_NUMBER="${{ github.event.pull_request.number }}"
                  REPO="${{ github.repository }}"

                  # Check if we already commented
                  EXISTING_COMMENT=$(gh api "/repos/$REPO/issues/$PR_NUMBER/comments" \
                    --jq '.[] | select(.body | contains("E2E Tests Approval Required")) | .id' | head -n1)

                  if [[ -n "$EXISTING_COMMENT" ]]; then
                    echo "Approval comment already exists (ID: $EXISTING_COMMENT)"
                    exit 0
                  fi

                  gh pr comment "$PR_NUMBER" --repo "$REPO" --body '## ‚ö†Ô∏è E2E Tests Approval Required

                  This PR is from an external contributor and requires manual review before E2E tests can run.

                  **For maintainers:** 
                  1. Review the changes in this PR carefully
                  2. If safe to run E2E tests, add the `e2e-approved` label to this PR
                  3. E2E tests will automatically trigger once the label is added

                  **Note:** Fast feedback checks (linting, unit tests, build) run automatically and don'\''t require approval.'

    e2e_server:
        name: E2E Server (Tailscale)
        runs-on: ubuntu-latest
        needs: check-approval
        if: needs.check-approval.outputs.should-run == 'true'
        timeout-minutes: 10
        steps:
            - name: Connect to Tailscale
              uses: tailscale/github-action@v4
              with:
                  oauth-client-id: ${{ secrets.TS_OAUTH_CLIENT_ID }}
                  oauth-secret: ${{ secrets.TS_OAUTH_SECRET }}
                  tags: tag:ci-immich-go
                  hostname: ${{ env.e2e_server }}
                  args: --ssh

            - name: Prepare the server environment
              run: |
                  mkdir -p ${{ env.e2e_folder}}
                  touch ${{ env.e2e_users}}

            - name: Deploy Immich
              run: |
                  echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
                  echo "  Immich E2E Provisioning"
                  echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"

                  mkdir -p "${e2e_folder}"
                  cd "${e2e_folder}"

                  echo "üì• Downloading docker-compose.yml..."
                  curl -fsSL "https://github.com/immich-app/immich/releases/latest/download/docker-compose.yml" -o docker-compose.yml
                  curl -fsSL "https://github.com/immich-app/immich/releases/latest/download/example.env" -o .env

                  echo "üì• Pulling Immich images..."
                  docker compose pull -q

                  echo "üöÄ Starting Immich services..."
                  docker compose up -d --build --renew-anon-volumes --force-recreate --remove-orphans

            - name: Show Immich containers status
              run: |
                  docker compose -f ${{env.e2e_folder}}/docker-compose.yml ps

            - name: Wait for Immich API to be ready
              run: |
                  echo "‚è≥ Waiting for Immich API to be ready..."
                  TIMEOUT=180
                  ELAPSED=0

                  while [ $ELAPSED -lt $TIMEOUT ]; do
                    if curl -sf "${{ env.e2e_url }}/api/server/ping" > /dev/null 2>&1; then
                      echo "‚úÖ API is ready (took ${ELAPSED}s)"
                      exit 0
                    fi
                    sleep 2
                    ELAPSED=$((ELAPSED + 2))
                  done

                  echo "‚ùå Immich API did not become ready within ${TIMEOUT} seconds"
                  docker compose -f ${{env.e2e_folder}}/docker-compose.yml ps
                  docker compose -f ${{env.e2e_folder}}/docker-compose.yml logs --tail=50 immich-server
                  exit 1

            - name: Keep server running for tests
              run: |
                  echo "Server is running and accessible via Tailscale"
                  echo "Waiting for client tests to complete..."
                  max_wait=${{ env.runner_timeout}}
                  elapsed=0
                  done_marker="${{ env.e2e_folder }}/done"

                  while [ $elapsed -lt $max_wait ]; do
                    if [ -f "$done_marker" ]; then
                      echo "‚úÖ Done marker found! Tests completed."
                      echo "Server ran for ${elapsed}s"
                      exit 0
                    fi
                    
                    sleep 5
                    elapsed=$((elapsed + 5))
                    echo "Waited ${elapsed}s / ${max_wait}s for tests..."
                  done

                  echo "‚ö†Ô∏è Maximum wait time reached without done marker, shutting down server"
                  exit 1

            - name: Show Immich logs on failure
              if: failure()
              run: |
                  echo "=== Immich Server Logs ==="
                  docker compose -f ${{env.e2e_folder}}/docker-compose.yml logs
                  echo "=== All Container Status ==="
                  docker compose -f ${{env.e2e_folder}}/docker-compose.yml ps

            - name: Cleanup Immich Instance
              if: always()
              run: |
                  docker compose -f ${{env.e2e_folder}}/docker-compose.yml down --volumes --remove-orphans || true
                  docker system prune -f || true

    e2e-linux:
        name: E2E Tests (Linux Client)
        runs-on: ubuntu-latest
        needs: check-approval
        if: needs.check-approval.outputs.should-run == 'true'
        timeout-minutes: 10
        steps:
            - name: Checkout Code
              uses: actions/checkout@v5

            - name: Setup Go
              uses: actions/setup-go@v6
              with:
                  go-version-file: "go.mod"
                  cache-dependency-path: "go.sum"

            - name: Connect to Tailscale
              uses: tailscale/github-action@v4
              with:
                  oauth-client-id: ${{ secrets.TS_OAUTH_CLIENT_ID }}
                  oauth-secret: ${{ secrets.TS_OAUTH_SECRET }}
                  tags: tag:ci-immich-go
                  hostname: e2e-linux-${{ github.run_id }}
                  args: --ssh

            - name: Wait for Immich API to be ready
              run: |
                  echo "‚è≥ Waiting for Immich API..."
                  TIMEOUT=180
                  ELAPSED=0

                  while [ $ELAPSED -lt $TIMEOUT ]; do
                    if curl -sf "${{ env.e2e_url }}/api/server/ping" > /dev/null 2>&1; then
                      echo "‚úÖ API ready (${ELAPSED}s)"
                      exit 0
                    fi
                    sleep 2
                    ELAPSED=$((ELAPSED + 2))
                  done

                  echo "‚ùå API timeout after ${TIMEOUT}s"
                  exit 1

            - name: Create admin user
              run: |
                  mkdir -p "${e2e_folder}"
                  echo "üë• Creating admin user..."
                  cd ${{env.project_dir}}/internal/e2e/e2eUtils/cmd/createUser
                  go run createUser.go create-admin > "${e2e_folder}/e2eusers.env"
                  cat "${e2e_folder}/e2eusers.env"

            - name: Copy the e2eusers.env to the server for later use
              run: |
                  echo "Copying e2eusers.env to the server..."
                  scp -o StrictHostKeyChecking=no ${{ env.e2e_folder }}/e2eusers.env ${{ env.e2e_ssh }}:${{ env.e2e_folder }}/e2eusers.env

            - name: Run E2E Tests on Linux
              run: |
                  cd ${{ env.project_dir}}/internal/e2e/client
                  go test -v -tags=e2e -timeout=30m ./...
              env:
                  CGO_ENABLED: 0

    e2e-windows:
        name: E2E Tests (Windows Client)
        runs-on: windows-latest
        needs: [check-approval, e2e-linux]
        if: needs.check-approval.outputs.should-run == 'true'
        timeout-minutes: 10
        env:
            project_dir: d:\a\immich-go\immich-go
            e2e_folder: d:\a\immich-go\immich-go\e2e-immich
            e2e_users_folder: d:\a\immich-go\immich-go\internal\e2e\testdata\immich-server
            e2e_users: d:\a\immich-go\immich-go\internal\e2e\testdata\immich-server\e2eusers.env
            e2e_users_server: /home/runner/work/immich-go/immich-go/internal/e2e/testdata/immich-server/e2eusers.env

        steps:
            - name: Checkout Code
              uses: actions/checkout@v5

            - name: Setup Go
              uses: actions/setup-go@v6
              with:
                  go-version-file: "go.mod"
                  cache-dependency-path: "go.sum"

            - name: Connect to Tailscale
              uses: tailscale/github-action@v4
              with:
                  oauth-client-id: ${{ secrets.TS_OAUTH_CLIENT_ID }}
                  oauth-secret: ${{ secrets.TS_OAUTH_SECRET }}
                  tags: tag:ci-immich-go
                  hostname: e2e-windows-${{ github.run_id }}

            - name: Wait for Immich API to be ready
              shell: pwsh
              run: |
                  Write-Host "‚è≥ Waiting for Immich API to be ready..." -ForegroundColor Yellow
                  $TIMEOUT = 180
                  $ELAPSED = 0
                  $READY = $false

                  while ($ELAPSED -lt $TIMEOUT) {
                    try {
                      $response = Invoke-WebRequest -Uri "${{ env.e2e_url }}/api/server/ping" -Method Get -UseBasicParsing -ErrorAction SilentlyContinue
                      if ($response.StatusCode -eq 200) {
                        $READY = $true
                        break
                      }
                    }
                    catch {
                      # API not ready yet, continue waiting
                    }
                    Write-Host "  ‚è±  Still waiting... ($ELAPSED`s / $TIMEOUT`s)" -ForegroundColor Blue
                    Start-Sleep -Seconds 2
                    $ELAPSED += 2
                  }

                  if (-not $READY) {
                    Write-Host "‚ùå Immich API did not become ready within $TIMEOUT seconds" -ForegroundColor Red
                    exit 1
                  }

                  Write-Host "‚úÖ API is ready" -ForegroundColor Green

            - name: Copy the e2eusers.env from the server
              shell: pwsh
              run: |
                  Write-Host "Copying e2eusers.env from the server..." -ForegroundColor Yellow
                  New-Item -Path "${{ env.e2e_users_folder }}" -ItemType Directory -Force | Out-Null
                  scp -o StrictHostKeyChecking=no "${{ env.e2e_ssh }}:${{ env.e2e_users_server }}" "${{ env.e2e_users }}"
                  Get-Content "${{ env.e2e_users }}"

            - name: Run E2E Tests on Windows
              shell: pwsh
              run: |
                  Set-Location -Path "${{ env.project_dir }}\internal\e2e\client"
                  go test -v -tags=e2e -timeout=30m ./...
              env:
                  CGO_ENABLED: 0

    e2e-cleanup:
        name: E2E Cleanup
        runs-on: ubuntu-latest
        timeout-minutes: 2
        needs: [check-approval, e2e-linux, e2e-windows]
        if: always() && needs.check-approval.outputs.should-run == 'true'
        steps:
            - name: Connect to Tailscale
              uses: tailscale/github-action@v4
              with:
                  oauth-client-id: ${{ secrets.TS_OAUTH_CLIENT_ID }}
                  oauth-secret: ${{ secrets.TS_OAUTH_SECRET }}
                  tags: tag:ci-immich-go
                  args: --ssh
                  hostname: e2e-cleanup-${{ github.run_id }}

            - name: Create done marker file
              run: |
                  echo "Creating done marker file on server..."
                  ssh -o StrictHostKeyChecking=no ${{ env.e2e_ssh }} "touch ${{ env.e2e_folder }}/done"
                  echo "‚úÖ Done marker created"

    e2e-cancel-on-failure:
        name: Cancel on E2E Server Failure
        runs-on: ubuntu-latest
        timeout-minutes: 2
        needs: [check-approval, e2e_server]
        if: failure() && needs.check-approval.outputs.should-run == 'true'
        steps:
            - name: Cancel all jobs in this workflow
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                  echo "‚ùå E2E server deploy failed ‚Äî cancelling remaining jobs..."
                  curl -s -X POST \
                    -H "Accept: application/vnd.github+json" \
                    -H "Authorization: Bearer $GITHUB_TOKEN" \
                    https://api.github.com/repos/${{ github.repository }}/actions/runs/${{ github.run_id }}/cancel
