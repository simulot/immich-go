name: E2E Tests

on:
    pull_request:
        branches:
            - main
            - develop
    workflow_dispatch:

permissions:
    contents: read

jobs:
    # E2E tests for Linux client
    # Each platform runs independently with its own Immich instance
    e2e-linux:
        name: E2E Tests (Linux Client)
        runs-on: ubuntu-latest

        steps:
            - name: Checkout Code
              uses: actions/checkout@v5

            - name: Setup Go
              uses: actions/setup-go@v6
              with:
                  go-version-file: "go.mod"
                  cache-dependency-path: "go.sum"

            - name: Deploy Immich Test Instance
              run: |
                  cd internal/e2e/e2eUtils/cmd/deployImmich
                  go run deployImmich.go ../../../immich-test
              env:
                  CGO_ENABLED: 0

            - name: Wait for Immich API
              run: |
                  echo "Waiting for Immich API to be ready..."
                  timeout 180 bash -c 'until curl -sf http://localhost:2283/api/server/ping > /dev/null 2>&1; do sleep 2; done'
                  echo "Immich API is ready!"

            - name: Show Immich containers status
              run: |
                  docker compose -f internal/e2e/immich-test/docker-compose.yml ps

            - name: Run E2E Tests on Linux
              run: |
                  cd internal/e2e/e2eTests
                  go test -v -tags=e2e -timeout=30m ./...
              env:
                  CGO_ENABLED: 0

            - name: Show Immich logs on failure
              if: failure()
              run: |
                  echo "=== Immich Server Logs ==="
                  docker compose -f internal/e2e/immich-test/docker-compose.yml logs immich-server
                  echo "=== All Container Status ==="
                  docker compose -f internal/e2e/immich-test/docker-compose.yml ps

            - name: Cleanup Immich Instance
              if: always()
              run: |
                  docker compose -f internal/e2e/immich-test/docker-compose.yml down --volumes --remove-orphans || true
                  docker system prune -f || true

    # E2E tests for Windows client (tests immich-go client behavior on Windows)
    # Note: Immich server runs via Docker Desktop/WSL2 on Windows runner
    # This tests Windows-specific client behavior (paths, permissions, file handling)
    e2e-windows:
        name: E2E Tests (Windows Client)
        runs-on: windows-latest

        steps:
            - name: Checkout Code
              uses: actions/checkout@v5

            - name: Setup Go
              uses: actions/setup-go@v6
              with:
                  go-version-file: "go.mod"
                  cache-dependency-path: "go.sum"

            - name: Deploy Immich Test Instance
              shell: bash
              run: |
                  cd internal/e2e/e2eUtils/cmd/deployImmich
                  go run deployImmich.go ../../../immich-test
              env:
                  CGO_ENABLED: 0

            - name: Wait for Immich API
              shell: bash
              run: |
                  echo "Waiting for Immich API to be ready..."
                  for i in {1..90}; do
                    if curl -sf http://localhost:2283/api/server/ping > /dev/null 2>&1; then
                      echo "Immich API is ready!"
                      exit 0
                    fi
                    sleep 2
                  done
                  echo "Timeout waiting for Immich API"
                  exit 1

            - name: Show Immich containers status
              shell: bash
              run: |
                  docker compose -f internal/e2e/immich-test/docker-compose.yml ps

            - name: Run E2E Tests on Windows
              shell: bash
              run: |
                  cd internal/e2e/e2eTests
                  go test -v -tags=e2e -timeout=30m ./...
              env:
                  CGO_ENABLED: 0

            - name: Show Immich logs on failure
              if: failure()
              shell: bash
              run: |
                  echo "=== Immich Server Logs ==="
                  docker compose -f internal/e2e/immich-test/docker-compose.yml logs immich-server || true
                  echo "=== All Container Status ==="
                  docker compose -f internal/e2e/immich-test/docker-compose.yml ps || true

            - name: Cleanup Immich Instance
              if: always()
              shell: bash
              run: |
                  docker compose -f internal/e2e/immich-test/docker-compose.yml down --volumes --remove-orphans || true
                  docker system prune -f || true
