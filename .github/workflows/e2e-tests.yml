name: E2E Tests

on:
  pull_request:
    branches:
      - main
      - develop
  workflow_dispatch:

permissions:
  contents: read

env:
  project_dir: /home/runner/work/immich-go/immich-go
  e2e_folder: /home/runner/work/immich-go/immich-go/e2e-immich
  e2e_users: /home/runner/work/immich-go/immich-go/e2e-immich/e2eusers.yml
  e2e_compose: /home/runner/work/immich-go/immich-go/e2e-immich/docker-compose.yml
  e2e_server: e2e-immich-${{ github.run_id }}
  e2e_url: http://e2e-immich-${{ github.run_id }}:2283
  e2e_ssh: root@e2e-immich-${{ github.run_id }}
  runner_timeout: 900

jobs:
  # Immich server runs on its own runner and connects to Tailscale
  e2e_server:
    name: Immich Server (Tailscale)
    runs-on: ubuntu-latest

    steps:
      - name: Connect to Tailscale
        uses: tailscale/github-action@v4
        with:
          oauth-client-id: ${{ secrets.TS_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ secrets.TS_OAUTH_SECRET }}
          tags: tag:ci-immich-go
          hostname: ${{ env.e2e_server }}
          args: --ssh

      - name: Prepare the server environment
        run: |
          mkdir -p ${{ env.e2e_folder}}
          touch ${{ env.e2e_users}}

      - name: Checkout Code
        uses: actions/checkout@v5

      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version-file: "go.mod"
          cache-dependency-path: "go.sum"

      - name: Deploy Immich and get user's key
        run: |
          cd ${{ env.project_dir }}/internal/e2e/e2eUtils/cmd/deployImmich
          go run deployImmich.go "${{env.e2e_folder}}"

      - name: Verify user's key generation
        run: |
          if [ ! -f "${{env.e2e_folder}}/e2eusers.yml" ]; then
            echo "❌ User's key not found"
            exit 1
          fi
          echo "✅ User keys found"
          cat "${{env.e2e_folder}}/e2eusers.yml"

      - name: Show Immich containers status
        run: |
          docker compose -f ${{env.e2e_folder}}/docker-compose.yml ps

      - name: Keep server running for tests
        run: |
          echo "Server is running and accessible via Tailscale"
          echo "Waiting for client tests to complete..."
          max_wait=${{ env.runner_timeout}}
          elapsed=0
          done_marker="${{ env.e2e_folder }}/done"

          while [ $elapsed -lt $max_wait ]; do
            # Check if done marker file exists
            if [ -f "$done_marker" ]; then
              echo "✅ Done marker found! Tests completed."
              echo "Server ran for ${elapsed}s"
              exit 0
            fi
            
            sleep 5
            elapsed=$((elapsed + 5))
            echo "Waited ${elapsed}s / ${max_wait}s for tests..."
          done

          echo "⚠️ Maximum wait time reached without done marker, shutting down server"
          exit 1

      - name: Show Immich logs on failure
        if: failure()
        run: |
          echo "=== Immich Server Logs ==="
          docker compose -f ${{env.e2e_folder}} logs ${{ env.e2e_server }}
          echo "=== All Container Status ==="
          docker compose -f ${{env.e2e_folder}} ps

      - name: Cleanup Immich Instance
        if: always()
        run: |
          docker compose -f ${{env.e2e_folder}} down --volumes --remove-orphans || true
          docker system prune -f || true

  # Linux client runs on its own runner and connects to server via Tailscale
  e2e-linux:
    name: E2E Tests (Linux Client)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v5

      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version-file: "go.mod"
          cache-dependency-path: "go.sum"

      - name: Connect to Tailscale
        uses: tailscale/github-action@v4
        with:
          oauth-client-id: ${{ secrets.TS_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ secrets.TS_OAUTH_SECRET }}
          tags: tag:ci-immich-go
          hostname: e2e-linux-${{ github.run_id }}

      - name: Wait for Immich API and copy e2eusers.yml
        run: |
          echo "Waiting for Immich API to be ready..."
          timeout 180 bash -c 'until curl -sf ${{ env.e2e_url }}/api/server/ping > /dev/null 2>&1; do sleep 2; done'
          echo "✅ Immich API is ready!"

          echo "Waiting for e2eusers.yml file to be created on server..."
          max_attempts=60
          attempt=0

          while [ $attempt -lt $max_attempts ]; do
            if ssh -o StrictHostKeyChecking=no ${{ env.e2e_ssh }} "test -f ${{ env.e2e_folder }}/e2eusers.yml"; then
              echo "✅ e2eusers.yml file found on server!"
              break
            fi
            attempt=$((attempt + 1))
            echo "Attempt $attempt/$max_attempts - waiting for e2eusers.yml..."
            sleep 2
          done

          if [ $attempt -eq $max_attempts ]; then
            echo "❌ Timeout: e2eusers.yml not found on server"
            exit 1
          fi

          # Create local directory and copy file from server
          mkdir -p ${{ env.e2e_folder }}
          echo "Copying e2eusers.yml from server..."
          scp -o StrictHostKeyChecking=no ${{ env.e2e_ssh }}:${{ env.e2e_folder }}/e2eusers.yml ${{ env.e2e_folder }}/e2eusers.yml

          echo "✅ e2eusers.yml copied successfully!"
          echo "=== E2E Users Configuration ==="
          cat ${{ env.e2e_folder }}/e2eusers.yml

      - name: Run E2E Tests on Linux
        run: |
          cd ${{ env.project_dir}}/internal/e2e/client
          # E2E_USERS=${{env.e2e_folder}}/e2eusers.yml
          # E2E_URL=${{env.e2e_url}}
          # E2E_SSH=${{env.e2e_ssh}}
          # E2E_FOLDER=${{env.e2e_folder}}
          # E2E_COMPOSE=${{env.e2e_compose}}
          go test -v -tags=e2e -timeout=30m ./...
        env:
          CGO_ENABLED: 0

  clean-up:
    name: Cleanup Immich Instance after tests
    runs-on: ubuntu-latest
    needs: [e2e-linux]
    if: always()

    steps:
      - name: Connect to Tailscale
        uses: tailscale/github-action@v4
        with:
          oauth-client-id: ${{ secrets.TS_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ secrets.TS_OAUTH_SECRET }}
          tags: tag:ci-immich-go
          args: --ssh
          hostname: e2e-cleanup-${{ github.run_id }}

      - name: Wait for Tailscale connection
        run: |
          echo "Waiting for Tailscale network to be ready..."
          max_attempts=60  # 300 seconds / 5 seconds per attempt
          attempt=0

          while [ $attempt -lt $max_attempts ]; do
            tailscale status
            if ping -c 1 ${{ env.e2e_server }} > /dev/null 2>&1; then
              echo "✅ Tailscale connection established!"
              break
            fi
            attempt=$((attempt + 1))
            echo "Attempt $attempt/$max_attempts - waiting for Tailscale..."
            sleep 5
          done

          if [ $attempt -eq $max_attempts ]; then
            echo "❌ Timeout: Could not establish Tailscale connection after 180 seconds"
            echo "Tailscale status:"
            tailscale status
            exit 1
          fi

      - name: Wait for Immich API
        run: |
          echo "Waiting for Immich API to be ready..."
          timeout 180 bash -c 'until curl -sf ${{ env.e2e_url }}/api/server/ping > /dev/null 2>&1; do sleep 2; done'
          echo "Immich API is ready!"

      - name: Check users
        run: |
          echo "=== E2E Users Configuration from Server ==="
          ssh -o StrictHostKeyChecking=no ${{ env.e2e_ssh }} "cat ${{ env.e2e_folder }}/e2eusers.yml"

      - name: Create done marker file
        run: |
          echo "Creating done marker file on server..."
          ssh -o StrictHostKeyChecking=no ${{ env.e2e_ssh }} "touch ${{ env.e2e_folder }}/done"
          echo "✅ Done marker created"

      # - name: Kill immich runner
      #   run: |
      #     ssh -o StrictHostKeyChecking=no ${{ env.e2e_ssh }} "docker compose -f ${{ env.e2e_folder }}/docker-compose.yml down --volumes --remove-orphans"
      #     ssh -o StrictHostKeyChecking=no ${{ env.e2e_ssh }} "sudo shutdown now"
