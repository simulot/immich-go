name: E2E Tests

on:
  pull_request:
    branches:
      - main
      - develop
  workflow_dispatch:

permissions:
  contents: read

env:
  project_dir: /home/runner/work/immich-go/immich-go
  e2e_folder: /home/runner/work/immich-go/immich-go/e2e-immich
  e2e_users: /home/runner/work/immich-go/immich-go/e2e-immich/e2eusers.yml
  e2e_compose: /home/runner/work/immich-go/immich-go/e2e-immich/docker-compose.yml
  e2e_server: e2e-immich-${{ github.run_id }}
  e2e_url: http://e2e-immich-${{ github.run_id }}:2283
  e2e_ssh: root@e2e-immich-${{ github.run_id }}
  runner_timeout: 900
  RED: \033[0;31m
  GREEN: \033[0;32m
  YELLOW: \033[1;33m
  BLUE: \033[0;34m
  NC: \033[0m

jobs:
  # Immich server runs on its own runner and connects to Tailscale
  e2e_server:
    name: Immich Server (Tailscale)
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Connect to Tailscale
        uses: tailscale/github-action@v4
        with:
          oauth-client-id: ${{ secrets.TS_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ secrets.TS_OAUTH_SECRET }}
          tags: tag:ci-immich-go
          hostname: ${{ env.e2e_server }}
          args: --ssh

      - name: Prepare the server environment
        run: |
          mkdir -p ${{ env.e2e_folder}}
          touch ${{ env.e2e_users}}

      - name: Deploy Immich
        run: |
          echo -e "--"
          echo -e "${BLUE}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
          echo -e "${BLUE}  Immich E2E Provisioning${NC}"
          echo -e "${BLUE}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
          echo ""
          echo -e "  ${BLUE}Installation Directory:${NC} ${e2e_folder}"
          echo ""

          mkdir -p "${e2e_folder}"
          cd "${e2e_folder}"

          echo -e "${YELLOW}üì• Downloading docker-compose.yml...${NC}"
          if ! curl -fsSL "https://github.com/immich-app/immich/releases/latest/download/docker-compose.yml" -o docker-compose.yml; then
              echo -e "${RED}‚ùå Failed to download docker-compose.yml${NC}"
              exit 1
          fi

          echo -e "üì• Downloading .env file..."
          if ! curl -fsSL "https://github.com/immich-app/immich/releases/latest/download/example.env" -o .env; then
              echo -e "‚ùå Failed to download .env file"
              exit 1
          fi

          # Pull Immich images
          echo -e "${YELLOW}üöÄ Starting Immich services...${NC}"
          if ! docker compose pull -q; then
              echo -e "${RED}‚ùå Failed to pull Immich images${NC}"
              docker compose logs
              exit 1
          fi


          # Start Immich services
          echo -e "${YELLOW}üöÄ Starting Immich services...${NC}"
          if ! docker compose up -d --build --renew-anon-volumes --force-recreate --remove-orphans; then
              echo -e "${RED}‚ùå Failed to start Immich services${NC}"
              docker compose logs
              exit 1
          fi

      - name: Show Immich containers status
        run: |
          docker compose -f ${{env.e2e_folder}}/docker-compose.yml ps

      - name: Wait for Immich API to be ready
        run: |
          echo -e "${YELLOW}‚è≥ Waiting for Immich API to be ready...${NC}"
          TIMEOUT=180
          ELAPSED=0
          READY=false

          while [ $ELAPSED -lt $TIMEOUT ]; do
            if curl -sf "${{ env.e2e_url }}/api/server/ping" > /dev/null 2>&1; then
              READY=true
              break
            fi
            echo -e "  ${BLUE}‚è±${NC}  Still waiting... (${ELAPSED}s / ${TIMEOUT}s)"
            sleep 2
            ELAPSED=$((ELAPSED + 2))
          done

          if [ "$READY" = false ]; then
            echo -e "${RED}‚ùå Immich API did not become ready within ${TIMEOUT} seconds${NC}"
            echo ""
            echo -e "${YELLOW}Container status:${NC}"
            docker compose -f ${{env.e2e_folder}}/docker-compose.yml ps
            echo ""
            echo -e "${YELLOW}Recent logs:${NC}"
            docker compose -f ${{env.e2e_folder}}/docker-compose.yml logs --tail=50 immich-server
            exit 1
          fi

          echo -e "${GREEN}‚úÖ API is ready${NC}"
          echo -e "${YELLOW}‚è≥ Waiting a few seconds for API to stabilize before creating users...${NC}"
          sleep 5

      - name: Provision a few users
        run: |
          echo -e "${YELLOW}üë• Creating test users...${NC}"
          #  Create a few test users 
          cd ${{env.project_dir}}/internal/e2e/e2eUtils/cmd/createUser
          go run createUser.go - <<EOF > "${e2e_folder}/e2eusers.env"
          create-admin
          create-user user1@immich.app user1
          create-user user2@immich.app user2
          create-user user3@immich.app user3
          EOF

      - name: Keep server running for tests
        run: |
          echo "Server is running and accessible via Tailscale"
          echo "Waiting for client tests to complete..."
          max_wait=${{ env.runner_timeout}}
          elapsed=0
          done_marker="${{ env.e2e_folder }}/done"

          while [ $elapsed -lt $max_wait ]; do
            # Check if done marker file exists
            if [ -f "$done_marker" ]; then
              echo "‚úÖ Done marker found! Tests completed."
              echo "Server ran for ${elapsed}s"
              exit 0
            fi
            
            sleep 5
            elapsed=$((elapsed + 5))
            echo "Waited ${elapsed}s / ${max_wait}s for tests..."
          done

          echo "‚ö†Ô∏è Maximum wait time reached without done marker, shutting down server"
          exit 1

      - name: Show Immich logs on failure
        if: failure()
        run: |
          echo "=== Immich Server Logs ==="
          docker compose -f ${{env.e2e_folder}} logs ${{ env.e2e_server }}
          echo "=== All Container Status ==="
          docker compose -f ${{env.e2e_folder}} ps

      - name: Cleanup Immich Instance
        if: always()
        run: |
          docker compose -f ${{env.e2e_folder}} down --volumes --remove-orphans || true
          docker system prune -f || true

  # # Linux client runs on its own runner and connects to server via Tailscale
  # e2e-linux:
  #   name: E2E Tests (Linux Client)
  #   runs-on: ubuntu-latest
  #   timeout-minutes: 10
  #   steps:
  #     - name: Checkout Code
  #       uses: actions/checkout@v5

  #     - name: Setup Go
  #       uses: actions/setup-go@v6
  #       with:
  #         go-version-file: "go.mod"
  #         cache-dependency-path: "go.sum"

  #     - name: Connect to Tailscale
  #       uses: tailscale/github-action@v4
  #       with:
  #         oauth-client-id: ${{ secrets.TS_OAUTH_CLIENT_ID }}
  #         oauth-secret: ${{ secrets.TS_OAUTH_SECRET }}
  #         tags: tag:ci-immich-go
  #         hostname: e2e-linux-${{ github.run_id }}
  #         args: --ssh

  #     - name: Wait for Immich API and copy e2eusers.yml
  #       run: |
  #         echo "Waiting for Immich API to be ready..."
  #         timeout 180 bash -c 'until curl -sf ${{ env.e2e_url }}/api/server/ping > /dev/null 2>&1; do sleep 2; done'
  #         echo "‚úÖ Immich API is ready!"

  #         echo "Waiting for e2eusers.yml file to be created on server..."
  #         max_attempts=60
  #         attempt=0

  #         while [ $attempt -lt $max_attempts ]; do
  #           if ssh -o StrictHostKeyChecking=no ${{ env.e2e_ssh }} "test -f ${{ env.e2e_folder }}/e2eusers.yml"; then
  #             echo "‚úÖ e2eusers.yml file found on server!"
  #             break
  #           fi
  #           attempt=$((attempt + 1))
  #           echo "Attempt $attempt/$max_attempts - waiting for e2eusers.yml..."
  #           sleep 2
  #         done

  #         if [ $attempt -eq $max_attempts ]; then
  #           echo "‚ùå Timeout: e2eusers.yml not found on server"
  #           exit 1
  #         fi

  #         # Create local directory and copy file from server
  #         mkdir -p ${{ env.e2e_folder }}
  #         echo "Copying e2eusers.yml from server..."
  #         scp -o StrictHostKeyChecking=no ${{ env.e2e_ssh }}:${{ env.e2e_folder }}/e2eusers.yml ${{ env.e2e_folder }}/e2eusers.yml

  #         echo "‚úÖ e2eusers.yml copied successfully!"
  #         echo "=== E2E Users Configuration ==="
  #         cat ${{ env.e2e_folder }}/e2eusers.yml

  #     - name: Run E2E Tests on Linux
  #       run: |
  #         cd ${{ env.project_dir}}/internal/e2e/client
  #         go test -v -tags=e2e -timeout=30m ./...
  #       env:
  #         CGO_ENABLED: 0

  # clean-up:
  #   name: Cleanup Immich Instance after tests
  #   runs-on: ubuntu-latest
  #   timeout-minutes: 2
  #   needs: [e2e-linux]
  #   if: always()

  #   steps:
  #     - name: Connect to Tailscale
  #       uses: tailscale/github-action@v4
  #       with:
  #         oauth-client-id: ${{ secrets.TS_OAUTH_CLIENT_ID }}
  #         oauth-secret: ${{ secrets.TS_OAUTH_SECRET }}
  #         tags: tag:ci-immich-go
  #         args: --ssh
  #         hostname: e2e-cleanup-${{ github.run_id }}

  #     - name: Create done marker file
  #       run: |
  #         echo "Creating done marker file on server..."
  #         ssh -o StrictHostKeyChecking=no ${{ env.e2e_ssh }} "touch ${{ env.e2e_folder }}/done"
  #         echo "‚úÖ Done marker created"

  # cancel-on-failure:
  #   name: Cancel Workflow on Deploy Failure
  #   runs-on: ubuntu-latest
  #   timeout-minutes: 2

  #   needs: [e2e_server]
  #   if: ${{ failure() }}
  #   steps:
  #     - name: Cancel all jobs in this workflow
  #       env:
  #         GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  #       run: |
  #         echo "‚ùå Deploy step failed ‚Äî cancelling all remaining jobs..."
  #         curl -s -X POST \
  #           -H "Accept: application/vnd.github+json" \
  #           -H "Authorization: Bearer $GITHUB_TOKEN" \
  #           https://api.github.com/repos/${{ github.repository }}/actions/runs/${{ github.run_id }}/cancel
