name: Fast Feedback CI

on:
    pull_request:
        branches:
            - main
            - develop
        paths:
            - "**.go"
            - "go.mod"
            - "go.sum"
            - ".github/workflows/fast-feedback.yml"
            - "main.go"
    push:
        branches:
            - main
            - develop
        paths:
            - "**.go"
            - "go.mod"
            - "go.sum"
            - ".github/workflows/fast-feedback.yml"
            - "main.go"
    workflow_dispatch:

permissions:
    contents: read

jobs:
    # Quick validation - fails fast
    validate:
        name: Validate Code Quality
        runs-on: ubuntu-latest
        steps:
            - name: Checkout Code
              uses: actions/checkout@v5

            - name: Setup Go
              uses: actions/setup-go@v6
              with:
                  go-version-file: "go.mod"
                  cache-dependency-path: "go.sum"

            - name: golangci-lint
              uses: golangci/golangci-lint-action@v8
              with:
                  version: latest

    # Unit tests on Linux (primary platform)
    test-linux:
        name: Unit Tests (Linux)
        runs-on: ubuntu-latest
        needs: validate
        steps:
            - name: Checkout Code
              uses: actions/checkout@v5

            - name: Setup Go
              uses: actions/setup-go@v6
              with:
                  go-version-file: "go.mod"
                  cache-dependency-path: "go.sum"

            - name: Run tests with coverage
              run: |
                  go test -race -v -count=1 -coverprofile=coverage.out ./...

            - name: Generate coverage report
              run: |
                  go tool cover -func=coverage.out

    # Quick build validation
    build-check:
        name: Build Validation
        runs-on: ubuntu-latest
        needs: validate
        steps:
            - name: Checkout Code
              uses: actions/checkout@v5

            - name: Setup Go
              uses: actions/setup-go@v6
              with:
                  go-version-file: "go.mod"
                  cache-dependency-path: "go.sum"

            - name: Build primary binary
              run: |
                  CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -o immich-linux-amd64 -ldflags="-s -w -extldflags=-static" main.go

            - name: Verify binary
              run: |
                  ./immich-linux-amd64 version || echo "Binary built successfully"

    # Unit tests on Windows (secondary platform)
    test-windows:
        name: Unit Tests (Windows)
        runs-on: windows-latest
        needs: validate
        steps:
            - name: Checkout Code
              uses: actions/checkout@v5

            - name: Setup Go
              uses: actions/setup-go@v6
              with:
                  go-version-file: "go.mod"
                  cache-dependency-path: "go.sum"

            - name: Run tests
              run: |
                  go test -v -count=1 ./...

    # Summary job - all checks must pass
    all-checks-passed:
        name: All Checks Passed
        runs-on: ubuntu-latest
        needs: [validate, test-linux, test-windows, build-check]
        steps:
            - name: Success
              run: |
                  echo "✅ All fast feedback checks passed!"
                  echo "- Code quality validation: ✅"
                  echo "- Linux unit tests: ✅"
                  echo "- Windows unit tests: ✅"
                  echo "- Build validation: ✅"
