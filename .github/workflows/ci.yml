name: CI

on:
  pull_request:
    branches:
      - main
      - develop
    paths:
      - "**.go"
      - "go.mod"
      - "go.sum"
      - ".github/workflows/ci.yml"
      - "main.go"
      - "internal/e2e/testdata/immich-server/**"
  push:
    branches:
      - main
      - develop
    paths:
      - "**.go"
      - "go.mod"
      - "go.sum"
      - ".github/workflows/ci.yml"
      - "main.go"
      - "internal/e2e/testdata/immich-server/**"
  workflow_dispatch:

permissions:
  contents: read

env:
  project_dir: /home/runner/work/immich-go/immich-go
  e2e_folder: /home/runner/work/immich-go/immich-go/internal/e2e/testdata/immich-server
  e2e_users: /home/runner/work/immich-go/immich-go/internal/e2e/testdata/immich-server/e2eusers.env
  e2e_server: e2e-immich-${{ github.run_id }}
  e2e_url: http://e2e-immich-${{ github.run_id }}:2283
  e2e_ssh: root@e2e-immich-${{ github.run_id }}
  runner_timeout: 900

jobs:
  validate-branch:
    name: Validate Branch Rules
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Check branch name and target
        run: |
          source_branch="${{ github.head_ref }}"
          target_branch="${{ github.base_ref }}"

          # Allow dependency management bot PRs to bypass naming convention
          # Matches: dependabot/*, renovate/*, etc.
          if [[ "${{ github.actor }}" == "dependabot[bot]" ]] || [[ "${{ github.actor }}" == "renovate[bot]" ]] || [[ "$source_branch" =~ ^(dependabot|renovate)/ ]]; then
            echo "Dependency management bot PR '$source_branch' is exempt from naming convention."
            exit 0
          fi

          # Allow certain system/integration branches to bypass naming convention
          if [[ "$source_branch" =~ ^(main|develop|master)$ ]]; then
            echo "System branch '$source_branch' is exempt from naming convention."
          else
            # Check if the source branch name is valid (feature/bugfix/fix/hotfix/chore)
            if ! [[ "$source_branch" =~ ^(feature|bugfix|fix|hotfix|chore)/.+$ ]]; then
              echo "::error::Branch name '$source_branch' does not follow the naming convention (feature/, bugfix/, fix/, hotfix/, chore/)."
              exit 1
            fi
          fi

          # Check if a feature, bugfix, fix, or chore branch is targeting the correct branch (develop)
          if [[ "$source_branch" =~ ^(feature|bugfix|fix|chore)/.+ ]] && [ "$target_branch" != "develop" ]; then
            echo "::error::'feature/*', 'bugfix/*', 'fix/*', and 'chore/*' branches must only be merged into 'develop'."
            exit 1
          fi

          # Check if a hotfix branch is targeting the correct branch (main)
          if [[ "$source_branch" =~ ^hotfix/.+ ]] && [ "$target_branch" != "main" ]; then
            echo "::error::'hotfix/*' branches must only be merged into 'main'."
            exit 1
          fi

          echo "✅ Branch rules validated successfully."

  validate:
    name: Code Quality & Tests
    runs-on: ubuntu-latest
    needs: validate-branch
    if: always() && (needs.validate-branch.result == 'success' || needs.validate-branch.result == 'skipped')
    steps:
      - name: Checkout Code
        uses: actions/checkout@v5

      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version-file: "go.mod"
          cache-dependency-path: "go.sum"

      - name: Lint
        uses: golangci/golangci-lint-action@v9
        with:
          version: latest

      - name: Unit Tests
        run: go test -race -v -count=1 -coverprofile=coverage.out ./...

      - name: Coverage Report
        run: go tool cover -func=coverage.out

      - name: Build Check
        run: CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -o immich-linux-amd64 -ldflags="-s -w -extldflags=-static" main.go

      - name: Verify Binary
        run: ./immich-linux-amd64 version || echo "✅ Binary built successfully"

  fast-feedback-complete:
    name: Fast Feedback Complete
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - name: All checks passed
        run: |
          echo "✅ All fast feedback checks passed!"
          echo ""
          echo "ℹ️  E2E tests run separately via the 'E2E Tests' workflow"
          echo "   - Automatic for trusted contributors and pushes to main/develop"
          echo "   - Manual approval required for external PRs"
